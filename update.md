# 更新日志

## 2024-05-31

### 修复<think>标签处理
- 优化消息处理流程，过滤掉<think>标签内的思考内容
- 在用户输入和历史消息处理中都添加了思考内容过滤
- 确保思考内容不会被发送到联网搜索或AI模型处理
- 保留原始消息显示格式，仅在处理时进行过滤

### 网络搜索关键词提取优化
- 改进搜索关键词提取，过滤掉用户思考内容
- 增强提示词指令，确保只提取客观事实部分
- 添加额外的正则过滤，移除"我在思考"等前缀
- 修复类型兼容性问题，确保配置正确加载

### 网络搜索功能升级
- 新增智能网络搜索功能，自动判断是否需要联网查询
- 优化搜索体验，使用直接网页抓取获取实时内容
- 支持多搜索引擎（Bing、Google）爬取，无需API密钥
- 完善搜索结果处理和展示，增强大模型回答准确性

### 技术实现
- 创建WebService服务，提供网络搜索、判断搜索需求、提取关键词等功能
- 使用原生fetch实现网络请求，无需额外依赖
- 集成搜索结果到大模型系统消息，保持对话上下文完整
- 优化搜索类型设置界面，移除不必要的配置选项

### 用户体验
- 启用网络搜索后，系统会在需要时自动搜索相关信息
- 搜索过程透明展示，用户可看到关键词提取和搜索状态
- 搜索结果直接整合到AI回复中，提供信息来源和链接

## 2023-11-21

### 功能优化
- 在消息发送后到接口响应前，添加加载中提示，提升用户体验
- 加载中提示直观展示AI思考状态，避免用户等待时无反馈的问题
- 优化加载状态控制逻辑，确保状态正确转换

### 技术细节
- 在ChatPanel组件中添加LoadingMessage组件用于显示加载状态
- 使用Spin组件实现加载动画效果
- 引入isLoading状态控制加载提示的显示和隐藏
- 在消息发送开始时设置加载状态，在收到第一个响应或发生错误时关闭加载状态

## 2024-06-01

### 优化：网络搜索参数配置化
- 将WebService中硬编码的搜索URL和User-Agent改为可配置参数
- 在WebSearchConfig组件中增加自定义搜索URL和User-Agent的高级设置功能
- 在settingsStore中增加对新配置参数的存储和读取
- 优化ChatPanel组件从配置获取和传递搜索参数
- 这些改进使程序在不同网络环境下更加灵活

### 修复：网络搜索结果处理方式
- 修正了搜索结果被错误地添加到用户消息中的问题
- 现在搜索结果被正确地作为独立的系统消息添加到对话中
- 大模型现在可以清晰区分用户输入和搜索结果
- 这一修复提高了对话的清晰度和AI回复的质量

## 2024-06-02

### 新增：会话请求终止功能
- 在AIService抽象类中添加了请求终止功能，支持按会话ID取消请求
- 在WebService中实现了请求跟踪和终止功能，使用AbortController管理请求生命周期
- 在OllamaService服务中添加了请求跟踪和终止实现
- 优化ChatPanel中的停止生成按钮，现在可以同时终止AI服务和网络搜索的所有相关请求
- 增强了用户体验，特别是在网络延迟较高的情况下，用户可以快速终止不需要的请求
- 添加了详细的请求状态日志，便于开发者调试和监控请求状态
- 优化了错误处理，对已取消的请求不再显示错误提示

### 优化：搜索结果智能解析处理

- 将原先简单格式化的搜索结果改为使用大模型进行智能解析
- 添加`parseSearchResultsWithAI`方法，使用大模型分析和结构化搜索结果数据
- 解析结果包含摘要、主要相关事实和注意事项
- 改进了搜索结果的呈现方式，使其对会话大模型更友好
- 优化了搜索信息与用户问题之间的关联性分析
- 提高了基于搜索数据的回答质量和相关性

### 重构：搜索服务架构优化

- 创建新的`RawSearchService`类，获取原始HTML而不进行自行解析
- 优化搜索流程，直接将HTML交给大模型解析，提高解析准确性
- 移除各个具体搜索服务中的HTML解析代码，统一由大模型处理
- 添加HTML裁剪机制，确保不超过模型处理能力
- 增强JSON结果解析的容错性，添加备选文本解析方案
- 整合HTML解析与搜索结果整理功能，简化接口调用流程

### 优化：网页内容处理改进

- 添加`extractTextFromHtml`方法，智能提取HTML中的纯文本内容
- 优化提取逻辑，保留标题、链接等关键内容的结构化信息
- 去除脚本、样式、注释等无关内容，降低模型处理负担
- 保留HTML中的逻辑结构，如段落、列表、换行等
- 将文本裁剪阈值从10万字符调整为5万字符，提高处理效率
- 显著提升搜索结果提取的准确性和相关性

### 重构：搜索服务HTML解析增强

- 更新`SearchResult`接口，添加`description`字段用于存储更详细的正文内容
- 增强所有搜索服务的HTML解析能力，提取更详细的网页正文内容
- 为Bing搜索添加完整的内容提取，使用`b_caption`类捕获更多文本
- 为Google搜索增加多层次内容提取，从div和span等多种元素捕获文本
- 为百度搜索优化内容提取，支持从容器和段落中获取更完整的内容
- 改进搜索结果显示，在简短摘要外同时提供更丰富的内容上下文
- 去除使用大模型解析HTML方法，恢复并增强了原始搜索服务处理代码 

### 新增：搜索结果AI分析整合功能

- 添加`extractKeyInfoWithAI`方法，使用大模型提取搜索结果中与用户问题最相关的关键信息
- 实现多步骤搜索处理流程：搜索、结果整理、AI分析、AI回答
- 增加搜索分析状态提示，明确显示"正在分析搜索结果"的中间状态
- 优化提示词工程，通过结构化要求让AI提取真正相关的关键信息
- 设计专业的信息提取格式，包括主题分类、主要事实要点和注意事项
- 添加错误处理机制，在分析失败时优雅降级使用原始搜索结果
- 这一功能显著提高了搜索信息的质量和针对性，使大模型能更准确理解搜索内容与用户问题的关联 

## 2024-06-03
### 优化：HTML内容提取与分析

- 新增`cleanHtmlAndExtractText`方法，采用更高效的方式处理HTML内容
- 实现了多步骤HTML清理流程：移除样式和脚本标签，提取body内容，去除剩余标签
- 先通过正则表达式去除所有样式相关内容，然后获取body里的纯文本
- 对提取的文本内容进行格式优化，确保可读性
- 添加错误处理和降级策略，保证在各种情况下都能提取有用内容

### 新增：网页内容深度解析功能

- 添加`analyzeHtmlContentWithAI`方法，直接解析网页原始内容
- 对搜索结果页面进行深度访问，提取完整的网页内容而非仅搜索摘要
- 实现对前三个高相关结果的原始网页内容抓取和处理
- 使用大模型对原始网页内容进行智能分析和信息提取
- 优化分析提示词，确保提取的信息与用户查询高度相关
- 改进搜索状态提示，展示"正在分析搜索结果并处理HTML内容"的详细状态
- 添加结果长度限制机制，防止过长内容影响模型处理

### 整合：多层次搜索与分析策略

- 将搜索结果处理从简单的摘要提取升级为完整的网页内容分析
- 改进ChatPanel中的搜索流程，使用新的网页内容分析替代简单的搜索结果提取
- 优化结果展示语言，使用"搜索完成并深度解析网页内容"提示更直观地表达处理深度
- 通过多层次的内容获取和分析，显著提高大模型对搜索内容的理解深度
- 整合了搜索与分析的完整流程：网页搜索→内容获取→HTML处理→AI分析→AI回答
- 这一优化使模型能获取更完整的原始信息，而不仅限于搜索引擎提供的简短摘要

### 修复：网页内容获取方式

- 修复了网页内容获取过程中的重大问题，之前错误地使用searchRaw方法导致二次搜索
- 将网页内容获取方法从searchRaw改为直接使用fetch请求获取原始链接内容
- 增加网页内容获取的错误处理和状态检查，确保在获取失败时能优雅降级
- 添加详细的日志输出，便于追踪网页内容获取过程和潜在问题
- 优化内容获取失败的后备策略，按优先级使用description或snippet作为替代内容
- 解决了出现多个搜索请求和错误搜索网址的问题，提高了系统稳定性

## 2024-06-04

### 优化：网络搜索结果来源和链接展示

- 改进所有搜索结果处理方法中的链接和来源展示方式
- 将之前的纯文本链接替换为Markdown格式链接 `[标题](链接)`
- 在AI分析提示词中明确要求为每个信息点标明来源和链接
- 优化了三种搜索结果处理方法：`formatSearchResultsForModel`、`parseSearchResultsWithAI`和`analyzeHtmlContentWithAI`
- 要求AI在回复中为每个信息点标记来源：`- [事实/信息] - 来源: [标题](链接)`
- 为每个搜索结果处理方法添加"在回答中引用信息的来源，以增加回答的可信度"的提示语
- 这一优化帮助用户更清晰地了解信息来源，提高搜索结果的可信度和透明度 

## 2024-06-05

### 修复搜索结果来源链接显示问题

- 修复了网络搜索结果中来源链接显示为"example.com"而非实际来源网站的问题
- 优化了三个主要搜索结果处理方法来正确显示来源：
  - `formatSearchResultsForModel`: 现在从结果链接URL中提取实际域名作为来源显示
  - `parseSearchResultsWithAI`: 使用真实域名代替搜索引擎域名
  - `analyzeHtmlContentWithAI`: 所有来源参考现在显示实际网站域名
- 更新了AI提示模板，确保所有信息点都明确标注其真实来源
- 这一修复提高了搜索结果的可信度和准确性，让用户能清楚识别信息的真实来源

### 新增：自定义搜索引擎支持

- 在WebService中添加了对自定义搜索引擎的支持
- 扩展了search方法，增加了'custom'搜索类型，支持使用用户自定义的搜索URL
- 在WebSearchConfig组件中添加了自定义搜索选项，允许用户选择"自定义搜索"
- 优化了WebSearchConfig组件的UI交互，当选择自定义搜索时自动展开高级设置
- 为自定义搜索添加了必填验证，确保用户提供有效的搜索URL
- 扩展了WebSearchType类型定义，增加了'custom'类型，确保类型安全
- 改进用户界面提示，清晰地解释了自定义搜索URL的使用方式和参数添加机制
- 为自定义搜索结果添加了专门的HTML解析逻辑，支持从各种网页提取标题、链接和描述
- 增强了用户体验，为使用特殊或私有搜索引擎的用户提供了灵活性 

## 2024-06-06

### 修复：聊天面板联网搜索菜单支持自定义搜索

- 更新了聊天面板中的联网搜索下拉菜单，添加了对自定义搜索选项的支持
- 修改了下拉菜单结构，当用户在设置中配置了自定义搜索URL时，自动显示"自定义搜索"选项
- 优化了Tooltip提示，当选择自定义搜索时会显示"当前联网搜索: 自定义搜索"
- 确保在点击自定义搜索选项时保留用户设置的搜索URL
- 这一修改使聊天面板和设置页面在自定义搜索功能上保持一致，增强了用户体验 

## 2024-06-07

### 优化：网络搜索自定义设置与内容分析

- **改进WebSearchConfig组件**：
  - 优化UI交互，自定义搜索选项现在会自动展开/关闭高级设置
  - 当选择自定义搜索时，高级设置自动展开且无法关闭，提高用户体验
  - 增强表单验证，当自定义搜索时必须填写搜索URL

- **增强网页内容分析能力**：
  - 添加可配置的最大分析结果数量，替代固定的前三个结果
  - 移除文本内容5000字符的截断限制，更全面地分析网页内容
  - 实现HTML智能分块处理机制：
    * 新增`chunkHtml`方法将HTML分割成指定大小的块
    * 添加`filterChunksByKeywords`方法基于关键词过滤HTML块
    * 自动从用户查询中提取关键词用于匹配相关内容
  - 添加`extractKeywords`方法通过AI提取查询关键词
  - 实现分块、匹配、合并的智能处理流程，更精准地提取网页相关内容

- **搜索结果处理优化**：
  - `WebServiceConfig`接口增加`maxResults`和`chunkSize`配置参数
  - 针对大型网页的分块处理，默认块大小为100字符
  - 对提取的网页内容进行关键词相关性过滤，减少无关内容
  - 过滤和保留与用户查询相关度最高的内容片段
  
这些优化使网络搜索结果的质量更高，内容更相关，同时提高了处理大型网页的效率。自动关键词匹配确保AI只分析与用户查询最相关的网页片段，提高了回答精准度。 

## 2024-06-08

### 优化：网络搜索设置界面与分析参数配置

- **重构联网搜索设置界面**：
  - 改进自定义搜索选项UI，选择"自定义搜索"时直接显示相关设置
  - 使用更直观的交互方式，不再使用折叠面板，改为直接显示相关设置项
  - 添加"高级配置"区域，作为单独的可折叠区域，适用于所有搜索类型

- **新增网页内容分析参数配置**：
  - 添加"最大分析结果数量"设置项，允许用户控制分析的搜索结果数（默认3个）
  - 添加"HTML分块大小"设置项，允许用户调整HTML分块处理的字符数（默认100字符）
  - 提供参数调整推荐范围和详细说明，帮助用户理解不同参数的影响
  - 为输入项添加单位标识（"个结果"和"字符"），提升UI友好度

- **Web服务配置增强**：
  - 扩展`WebSearchConfig`接口，添加maxResults和chunkSize属性
  - 完善存储机制，保存和读取新的配置参数
  - 确保配置在不同会话中保持一致
  - 更新配置说明文档，提供参数调整建议

这些优化使联网搜索功能更加易用和可配置，用户可以根据不同的需求场景调整参数，在搜索速度和内容深度之间找到平衡。 

## 2024-06-09

### 优化：网络搜索设置界面进一步改进

- **简化高级设置界面**：
  - 移除了高级设置区域的折叠面板，现在高级配置选项始终可见
  - 去除了展开/折叠的交互控件，提高了设置项的可发现性
  - 保留了分隔线和标题，使界面结构清晰

- **修复网络搜索设置传递**：
  - 修正了WebService配置参数传递问题，确保maxResults和chunkSize参数正确传递
  - 优化ChatPanel中的配置构建逻辑，完整传递所有搜索相关参数
  - 修复配置保存后在下次打开时可能丢失的问题

这些改进使网络搜索设置更加直观和易用，用户可以轻松调整性能相关参数，同时确保设置能被正确保存和使用。 

## 2024-06-10

### 新增：自定义搜索参数名称功能

- **增强自定义搜索配置**：
  - 添加了自定义搜索参数名称设置，默认为"q"
  - 不再硬编码使用"q"作为搜索参数，支持"query"、"keyword"等不同参数名
  - 提供直观的参数格式预览，显示最终搜索URL格式
  - 完善了配置UI设计，参数输入与URL输入配合得更紧密

- **优化搜索URL构建逻辑**：
  - 重构了自定义搜索URL构建逻辑，支持用户定义的参数名
  - 优化搜索参数拼接方式，自动判断URL中是否已包含参数符号
  - 增加更详细的日志输出，方便调试和排查问题

这一更新提高了对不同搜索引擎的兼容性，让用户可以灵活配置不同搜索引擎的参数名，而不再局限于使用"q"作为搜索参数。 

## 2024-06-11

### 优化：会话联网搜索菜单支持完整配置

- **改进聊天界面联网搜索菜单**：
  - 修复了"不使用联网搜索"选项在设置页面中缺失的问题
  - 优化所有搜索选项的处理逻辑，确保不会丢失用户配置的参数
  - 确保自定义搜索选项正确保留搜索参数名称(searchParam)设置
  - 统一各搜索选项的处理方式，提高代码可维护性

- **完善联网搜索配置交互**：
  - 优化联网搜索选项状态管理，提高用户体验一致性
  - 改进消息提示内容，使之更加清晰直观

这些优化确保了联网搜索配置在不同界面之间的一致性，用户在设置页面配置的自定义搜索参数能在聊天界面菜单中得到正确保留和应用。 

## 2024-06-12

### 优化：联网搜索下拉菜单交互改进

- **全面优化联网搜索下拉菜单**：
  - 添加搜索引擎选中状态指示，使当前选择更加清晰直观
  - 使用分组和分隔线优化菜单结构，提高视觉层次感
  - 为自定义搜索选项添加参数名提示，方便用户识别
  
- **增强自定义搜索配置引导**：
  - 当未配置自定义搜索URL时，显示禁用状态的菜单项
  - 提供"前往配置自定义搜索"快捷入口，引导用户完成配置
  - 添加明确的视觉提示，区分可用与不可用状态

- **完善气泡提示信息**：
  - 丰富联网搜索图标的Tooltip内容，显示当前搜索引擎状态
  - 对于自定义搜索，添加URL和参数名的详细信息
  - 使用清晰的文字描述，提高用户对当前状态的理解

这些优化使联网搜索功能的交互更加完善，特别是对自定义搜索配置提供了更友好的引导，帮助用户正确配置和使用这一功能。 

## 2024-06-13

### 优化：网络搜索下拉菜单界面美化

- **完全重构下拉菜单视觉样式**：
  - 采用更现代的布局设计，包含图标、文本与选中状态指示器
  - 统一菜单项内边距和对齐方式，提升视觉一致性
  - 为菜单添加圆角边框和阴影效果，增加层次感

- **增强选中状态视觉反馈**：
  - 使用醒目的主题色标识当前选中的搜索引擎
  - 优化选中图标位置，保持统一的左侧对齐布局
  - 添加细微的间距调整，提高视觉舒适度

- **改进自定义搜索选项展示**：
  - 为自定义搜索添加二级描述文本，直观展示当前参数设置
  - 禁用选项使用半透明效果，明确表示当前不可用状态
  - 配置入口使用主题色突出显示，引导用户快速找到设置入口

- **优化菜单整体布局**：
  - 添加顶部标题区域，清晰标识菜单功能
  - 使用自定义dropdownRender增强菜单容器样式
  - 调整整体内边距与间距，提供更舒适的视觉体验
  
这次界面优化大幅提升了网络搜索功能的用户体验，使下拉菜单不仅功能完善，而且拥有现代美观的视觉设计。 

## 2024-06-14

### 增强：网络搜索内容分析双重策略

- **实现内容解析双重处理策略**：
  - 添加基于关键词过滤的第一级解析策略，精准定位相关内容
  - 新增基于标题和正文提取的第二级解析策略，提高全面性
  - 建立错误回退机制，确保在任何情况下都能提供有用结果

- **新增标题和正文智能提取**：
  - 开发`extractTitleAndContent`专用方法，针对各类网页结构优化
  - 优先从article、main、content等语义标签提取正文内容
  - 自动提取h1-h4标题并与正文整合，保留文档结构
  - 智能降级处理，当无法找到主要内容区域时提取所有有意义段落

- **优化优先级处理流程**：
  - 首先尝试关键词过滤方法，提取与查询直接相关的内容片段
  - 如未找到足够内容，自动切换到标题和正文提取方法
  - 提高HTML解析效率，避免重复获取网页内容
  - 调整内存管理，在处理大型网页时降低资源占用

- **增强错误处理机制**：
  - 为每种处理策略添加独立的错误处理逻辑
  - 添加详细的日志输出，方便调试和问题诊断
  - 完善最终的结果回退机制，保证始终返回有用内容

这一功能增强显著提高了网络搜索的内容分析能力和准确性，确保即使在复杂的网页结构或特殊内容布局的情况下，也能提取出最有价值的信息，为大模型分析提供更优质的原材料。

## 2024-06-15

### 优化：联网搜索关键词提取和时效性内容处理

- **短问题直接搜索优化**：
  - 添加问题长度智能判断，当查询不超过38字符时跳过关键词提取
  - 减少短问题的处理时间，提高响应速度
  - 保留原始提问语义，避免关键词提取引起的误解

- **增强时效性内容处理**：
  - 修改关键词提取提示词，明确要求保留时间相关词语
  - 在提取中特别保留"今天"、"最新"、"当前"等表示时效性的关键词
  - 确保像"明天"、"未来"、"近期"等时间短语不被过滤掉

- **完善搜索结果分析**：
  - 新增"时效性信息"专门板块，突出显示包含日期时间的内容
  - 增强分析提示词，指导AI优先关注最新信息
  - 强制标注信息发布或更新时间，增加时效性透明度

- **技术改进**：
  - 优化日志输出，在关键词判断时记录详细过程
  - 减少不必要的AI调用，降低资源消耗
  - 维持错误处理机制的健壮性，确保即使在提取失败时仍能提供搜索服务

这些优化使网络搜索功能更加高效且智能，尤其增强了对时效性问题（如"今天的天气"、"最新新闻"等）的处理能力，提供更精准和实时的信息。 

## 2024-06-16

### 优化：联网搜索设置界面简化

- **移除冗余的"启用联网搜索"开关**：
  - 去除设置页面中的单独开关，使用搜索类型选择作为启用/禁用机制
  - 当选择"不使用联网搜索"时自动禁用搜索功能，其他选项则启用
  - 保留了所有现有功能，只是简化了界面设计

- **界面交互优化**：
  - 调整帮助文本，清晰说明选择"不使用联网搜索"将禁用联网功能
  - 基于搜索类型状态自动启用/禁用高级配置选项
  - 使用更清晰的选项命名，提高用户理解度

- **技术实现优化**：
  - 重构配置保存逻辑，自动根据搜索类型设置enabled状态
  - 移除不再需要的状态变量和处理函数
  - 更新文档说明，反映新的交互方式

这次优化使界面更加简洁且保持了功能完整性，消除了功能重叠带来的潜在混淆，让联网搜索设置更加直观易用。 

## 2024-06-17

### 优化：短问题直接搜索阈值提高

- **提高直接搜索阈值**：
  - 将短问题直接搜索的字符长度阈值从38个字符提高到50个字符
  - 对于50个字符以内的简短提问，直接使用原始问题进行联网搜索
  - 避免关键词提取可能导致的语义损失，保留原始提问的完整意图

- **提高响应效率**：
  - 减少短问题的处理环节，跳过不必要的关键词提取步骤
  - 加快短问题的响应速度，提升用户体验
  - 特别适合简短、直接的问题查询，如"今天北京天气如何"、"ChatGPT是什么"等

- **保留原始语义**：
  - 对于简短明确的问题，维持原始语义的完整性
  - 减少因关键词提取可能引入的误解或歧义
  - 提高搜索结果与用户实际问题的相关性

这一优化使系统对短问题的处理更加高效直接，同时保持了对长问题的关键词提取能力，让不同长度的问题都能获得最佳搜索体验。 